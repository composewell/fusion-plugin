<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Fusion.Plugin</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400i,700" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">fusion-plugin-v0.2.1: GHC plugin to make stream fusion more predictable.</span><ul class="links" id="page-menu"><li><a href="src/Fusion.Plugin.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th valign="top">Copyright</th><td>(c) 2019 Composewell Technologies</td></tr><tr><th>License</th><td>BSD-3-Clause</td></tr><tr><th>Maintainer</th><td>pranaysashank@composewell.com</td></tr><tr><th>Stability</th><td>experimental</td></tr><tr><th>Portability</th><td>GHC</td></tr><tr><th>Safe Haskell</th><td>None</td></tr><tr><th>Language</th><td>Haskell2010</td></tr></table><p class="caption">Fusion.Plugin</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">Using the Plugin</a></li><li><a href="#g:2">Implementation Details</a></li><li><a href="#g:3">Results</a></li><li><a href="#section.orphans">Orphan instances</a></li></ul></div></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Stream fusion depends on the GHC case-of-case transformations eliminating
 intermediate constructors.  Case-of-case transformation in turn depends on
 inlining. During core-to-core transformations GHC may create several
 internal bindings (e.g. join points) which may not get inlined because their
 size is bigger than GHC's inlining threshold. Even though we know that after
 fusion the resulting code would be smaller and more efficient. The
 programmer cannot force inlining of these bindings as there is no way for
 the programmer to address these bindings at the source level because they
 are internal, generated during core-to-core transformations. As a result
 stream fusion fails unpredictably depending on whether GHC was able to
 inline the internal bindings or not.</p><p><a href="https://gitlab.haskell.org/ghc/ghc/issues/17075">See GHC ticket #17075</a> for
 more details.</p><p>This plugin provides the programmer with a way to annotate certain types
 using a custom <code>Fuse</code> annotation. The programmer would annotate the
 types that are to be eliminated by fusion via case-of-case transformations.
 During the simplifier phase the plugin goes through the relevant bindings
 and if one of these types are found inside a binding then that binding is
 marked to be inlined irrespective of the size.</p><p>At the right places, fusion can provide dramatic performance improvements
 (e.g. 10x) to the code.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:plugin">plugin</a> :: <a href="https://hackage.haskell.org/package/ghc-8.10.1/docs/Plugins.html#t:Plugin" title="Plugins">Plugin</a></li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Using the Plugin</h1></a><div class="doc"><p>This plugin was primarily motivated by fusion issues discovered in
 <a href="https://github.com/composewell/streamly">streamly</a> but it can be used in
 general.</p><p>To use this plugin, add this package to your <code>build-depends</code>
 and pass the following to your ghc-options:</p><pre>ghc-options: -O2 -fplugin=Fusion.Plugin
</pre><p>To dump the core after each core to core transformation, pass the
 following to your ghc-options:</p><pre>ghc-options: -O2 -fplugin=Fusion.Plugin -fplugin-opt=Fusion.Plugin:dump-core
</pre><p>Output from each transformation is then printed in a different file.</p></div><a href="#g:2" id="g:2"><h1>Implementation Details</h1></a><div class="doc"><p>The plugin runs after the simplifier phase 0. It finds all non recursive
 join point bindings whose definition begins with a case match on a type that
 is annotated with <code>Fuse</code>. It then sets AlwaysInlinePragma on those
 bindings. This is followed by two runs of a gentle simplify pass that does
 both inlining and case-of-case. This is followed by the rest of CoreToDos.</p></div><a href="#g:3" id="g:3"><h1>Results</h1></a><div class="doc"><p>This plugin has been used extensively in the streaming library
 <a href="https://github.com/composewell/streamly">streamly</a>.  Several file IO
 benchmarks have shown 2x-6x improvements. With the use of this plugin stream
 fusion in streamly has become much more predictable which has been verified
 by inspecting the core generated by GHC and by inspection testing for the
 presence of the stream state constructors.</p></div><div class="top"><p class="src"><a id="v:plugin" class="def">plugin</a> :: <a href="https://hackage.haskell.org/package/ghc-8.10.1/docs/Plugins.html#t:Plugin" title="Plugins">Plugin</a> <a href="src/Fusion.Plugin.html#plugin" class="link">Source</a> <a href="#v:plugin" class="selflink">#</a></p></div><h1>Orphan instances</h1><div id="section.orphans"><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:o:ic:Outputable:Outputable:1"></span> <a href="https://hackage.haskell.org/package/ghc-8.10.1/docs/Outputable.html#t:Outputable" title="Outputable">Outputable</a> Fuse</span> <a href="src/Fusion.Plugin.html#line-680" class="link">Source</a> <a href="#v:-36-fOutputableFuse" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:o:ic:Outputable:Outputable:1"><summary class="hide-when-js-enabled">Instance details</summary><p></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:ppr">ppr</a> :: Fuse -&gt; <a href="https://hackage.haskell.org/package/ghc-8.10.1/docs/Outputable.html#t:SDoc" title="Outputable">SDoc</a> <a href="#v:ppr" class="selflink">#</a></p><p class="src"><a href="#v:pprPrec">pprPrec</a> :: <a href="https://hackage.haskell.org/package/base-4.14.0.0/docs/Prelude.html#t:Rational" title="Prelude">Rational</a> -&gt; Fuse -&gt; <a href="https://hackage.haskell.org/package/ghc-8.10.1/docs/Outputable.html#t:SDoc" title="Outputable">SDoc</a> <a href="#v:pprPrec" class="selflink">#</a></p></div></details></td></tr></table></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.24.0</p></div></body></html>